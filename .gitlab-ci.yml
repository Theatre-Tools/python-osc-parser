# GitLab CI/CD pipeline for Python OSC library
# Converted from GitHub Actions workflow

image: python:3.12

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip/

stages:
  - test
  - lint
  - check-types

# Test job with matrix for multiple Python versions
test:
  stage: test
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.10", "3.11", "3.12", "3.13", "3.14"]
  image: python:$PYTHON_VERSION
  before_script:
    - python -m pip install --upgrade pip
    - python -m pip install flake8 pytest mypy
  script:
    # Lint with flake8
    - echo "Running flake8 linting..."
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    # Check with mypy
    - echo "Running mypy type checking..."
    - mypy pythonosc examples
    # Test with pytest
    - echo "Running pytest tests..."
    - pytest

# Black formatting check
lint:
  stage: lint
  image: python:3.12
  before_script:
    - pip install black
  script:
    - black --check .

# Check types in published package
check-types-published:
  stage: check-types
  image: python:3.12
  script:
    - pip install build mypy
    - python -m build --sdist --wheel
    - temp=$(mktemp -d)
    - python -m venv $temp/venv
    - source $temp/venv/bin/activate
    - pip install mypy ./dist/*whl
    - cd $temp
    - echo 'import pythonosc' > demo.py
    - mypy demo.py